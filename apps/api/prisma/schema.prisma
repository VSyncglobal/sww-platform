generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum Role {
  MEMBER
  FINANCE_OFFICER
  TREASURER
  SECRETARY
  CHAIRPERSON
  SUPER_ADMIN
}

enum AccountStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEFAULTED
}

enum LoanStatus {
  PENDING_GUARANTORS      // Step 0: Waiting for guarantors
  PENDING_VERIFICATION    // Step 1: Finance Officer
  PENDING_APPROVAL        // Step 2: Chairperson
  APPROVED                // Step 3: Ready for Disbursement
  ACTIVE                  // Money Out
  COMPLETED               // Fully Paid
  DEFAULTED
  REJECTED
}

enum GuarantorStatus {
  PENDING_ADMIN_CHECK       // Step 1: Admin checks existence/funds (Silent)
  PENDING_FINANCE_APPROVAL  // Step 2: Finance Officer approves request sending
  PENDING_GUARANTOR_ACTION  // Step 3: Visible to Guarantor
  ACCEPTED
  REJECTED
}

enum WelfareType {
  BEREAVEMENT
  SICKNESS
  MATERNITY
  EDUCATION
  OTHER
}

enum WelfareStatus {
  PENDING
  PROCESSING
  APPROVED
  REJECTED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
  LOAN_INTEREST
  LOAN_PENALTY
  WELFARE_DEDUCTION
  SUBSCRIPTION
  PENALTY
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum PaymentProvider {
  MPESA
  BANK
  CASH
  SYSTEM
}

enum WorkflowStatus {
  PENDING_VERIFICATION
  PENDING_APPROVAL
  APPROVED_PENDING_DISBURSEMENT
  COMPLETED
  REJECTED
}

// --- MODELS ---

model User {
  id             String        @id @default(uuid())
  email          String        @unique
  phoneNumber    String        @unique
  passwordHash   String
  role           Role          @default(MEMBER)
  status         AccountStatus @default(PENDING)
  
  profile             MemberProfile?
  wallet              Wallet?
  loans               Loan[]        
  guarantees          Guarantor[] 
  monthlyReports      MonthlyReport[]  
  auditLogs           AuditLog[]
  withdrawalRequests  WithdrawalRequest[]
  welfareClaims       WelfareClaim[]    // <--- Added Relation
  
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@map("users")
}

model MemberProfile {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id])
  firstName       String
  lastName        String
  nationalId      String    @unique
  kraPin          String?   @unique
  dateOfBirth     DateTime
  gender          String
  nextOfKin       NextOfKin?
  beneficiaries   Beneficiary[]

  @@map("member_profiles")
}

model NextOfKin {
  id              String        @id @default(uuid())
  profileId       String        @unique
  profile         MemberProfile @relation(fields: [profileId], references: [id])
  fullName        String
  relationship    String
  phoneNumber     String
}

model Beneficiary {
  id              String        @id @default(uuid())
  profileId       String
  profile         MemberProfile @relation(fields: [profileId], references: [id])
  fullName        String
  relationship    String
  allocation      Float         
  
  @@map("beneficiaries")
}

model Wallet {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  savingsBalance  Decimal  @default(0) @db.Decimal(15, 2)
  lockedSavings   Decimal  @default(0) @db.Decimal(15, 2)
  welfareBalance  Decimal  @default(0) @db.Decimal(15, 2)
  loanBalance     Decimal  @default(0) @db.Decimal(15, 2)
  accruedInterest Decimal  @default(0) @db.Decimal(15, 2)
  finesBalance    Decimal  @default(0) @db.Decimal(15, 2)
  transactions    Transaction[]
  updatedAt       DateTime @updatedAt
}

model Transaction {
  id              String            @id @default(uuid())
  walletId        String
  wallet          Wallet            @relation(fields: [walletId], references: [id])
  amount          Decimal           @db.Decimal(15, 2)
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  provider        PaymentProvider   @default(SYSTEM)
  referenceCode   String   @unique
  description     String?
  metadata        Json?    
  createdAt       DateTime @default(now())

  @@map("transactions")
}

model Loan {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  principal       Decimal     @db.Decimal(15, 2)
  interest        Decimal     @db.Decimal(15, 2)
  totalDue        Decimal     @db.Decimal(15, 2)
  balance         Decimal     @db.Decimal(15, 2)
  rate            Decimal     @default(0.05)
  duration        Int         @default(30)
  status          LoanStatus  @default(PENDING_VERIFICATION)
  adminNotes      String?     @db.Text // <--- Added for Admin Verification Notes
  appliedAt       DateTime    @default(now())
  disbursedAt     DateTime?   
  dueDate         DateTime?   
  guarantors      Guarantor[]

  @@map("loans")
}

model Guarantor {
  id              String          @id @default(uuid())
  loanId          String
  loan            Loan            @relation(fields: [loanId], references: [id])
  
  // Guarantor logic updated for email-first verification
  guarantorEmail  String          
  userId          String?         
  user            User?           @relation(fields: [userId], references: [id])
  
  amountLocked    Decimal         @db.Decimal(15, 2)
  status          GuarantorStatus @default(PENDING_ADMIN_CHECK)
  
  createdAt       DateTime        @default(now())
  
  @@map("guarantors")
}

// NEW: Welfare / Benevolence Model
model WelfareClaim {
  id              String       @id @default(uuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  
  type            WelfareType
  description     String
  documentUrl     String?      // Vercel Blob URL
  amountRequested Decimal      @db.Decimal(15, 2)
  
  status          WelfareStatus @default(PENDING)
  adminNotes      String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("welfare_claims")
}

model AuditLog {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  action        String   
  details       String?  
  resourceId    String?  
  ipAddress     String?
  userAgent     String?
  timestamp     DateTime @default(now())

  @@map("audit_logs")
}

model WithdrawalRequest {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  amount      Decimal  @db.Decimal(15, 2)
  reason      String?
  destination String 
  status      WorkflowStatus @default(PENDING_VERIFICATION)
  verifiedBy  String? 
  approvedBy  String? 
  disbursedBy String? 
  rejectionReason String?
  transactionId String? @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("withdrawal_requests")
}

model MonthlyReport {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  month         String   
  totalSaved    Decimal  @default(0)
  totalBorrowed Decimal  @default(0)
  netPosition   Decimal  @default(0)
  createdAt     DateTime @default(now())

  @@unique([userId, month])
}